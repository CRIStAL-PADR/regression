SOFA Regression Documentation
==================

This repository contains:
- The tests to be perform on the scene for non regression: /Regression_test/
- All the reference file of the tested scenes: /References

# Regression Test general mechanism #

## Regression-tests files ##
The Regression_test program will search for \*.regression-tests files in the target directory (Sofa directory).
This file contains a list of scene to be tested. Each line of the list file must contain: a local path to the scene, the number of simulation steps to run, a numerical epsilon for comparison and optinally if mechanicalObject inside a mapped Node need to be tested.
See for example: SOFA_DIR/examples/RegressionStateScenes.regression-tests

```
### Demo scenes ###
Demos/caduceus.scn 100 1e-3
Demos/TriangleSurfaceCutting.scn 100 1e-4 1
Demos/liver.scn 100 1e-4 1
```

The class @sa RegressionSceneList is used to parse folders and look for a specific file containing the list of scene to test.
Right now we have:
- For state tests: RegressionStateScenes.regression-tests
- For topology tests: RegressionTopologyScenes.regression-tests


## Reference

Reference files are stored in this repository under **References/** folder, in the same folder hiearchy as the target scenes.
For example for Demo scenes inside sofa, references will be inside References/Demos/

The reference files are generated when running the test for the first time on a scene and must be manually added to this repository.

If the result of the simulation changed voluntarily, those files must be locally deleted so they can be regenerated by running the tests. Their modifications must be pushed to the repository.


## Non Regression Tests

For each line of the *regression-tests* file, the class @sa RegressionSceneList store all the parameters, as well as the scene path and its reference path, inside the a structure @sa RegressionSceneData .

The result of this process is thus a vector of @sa RegressionSceneData strutures: ```std::vector<RegressionSceneData> m_scenes;```

Then, for each RegressionSceneData a gtest is created and the method **runTest** from the Regression_test class will be called to really perform the test (or create the reference).


For the moment non regression tests class are: 
- **StateRegression_test**: At each step, the state (position/velocity) of every independent dofs is compared to values in reference files.
- **TopologyRegression_test**: At each step, the number of topology element of every topology container is compared to values in reference files.



# How to add new tests

## Add a scene to be tested

## Add a new non regression test
```
/// Create one instance of StateRegression_test per scene in stateRegressionSceneList.m_scenes list
/// Note: if N differents TEST_P(StateRegression_test, test_N) are created this will create M x N gtest. M being the number of values in the list.
INSTANTIATE_TEST_CASE_P(Regression_test,
    StateRegression_test,
    ::testing::ValuesIn( stateRegressionSceneList.m_scenes ),
    StateRegression_test::getTestName);

// Run state regression test on the listed scenes
TEST_P(StateRegression_test, sceneTest)
{
    runTest(GetParam());
}
```
