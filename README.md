SOFA Regression Documentation
==================

**This repository contains:**
- The tests to be perform on the scene for non regression: */Regression_test/*
- All the reference file of the tested scenes: */References*

# Regression Test general mechanism #

## Regression-tests files ##
The **Regression_test** program will search for **\*.regression-tests** files in the target directory (SOFA directory).
This file contains a list of scene to be tested. 
Each line of the list file must contain: 
- A local path to the scene
- The number of simulation steps to run
- A numerical epsilon for comparison 
- Optinally if mechanicalObject inside a mapped Node need to be tested.

See for example: SOFA_DIR/examples/RegressionStateScenes.regression-tests
```
### Demo scenes ###
Demos/caduceus.scn 100 1e-3
Demos/TriangleSurfaceCutting.scn 100 1e-4 1
Demos/liver.scn 100 1e-4 1
```

The class ```RegressionSceneList``` is used to parse folders and look for those files.
Right now we have:
- For state tests: RegressionStateScenes.regression-tests
- For topology tests: RegressionTopologyScenes.regression-tests


## References

Reference files are stored in this repository under the **References/** folder, with the same folder hiearchy as the target scenes.
*For example, for Demo scenes inside SOFA, references will be stored inside **References/Demos/** *

**The reference files are generated when running the test for the first time on a scene and must be manually added to this repository.**

If the result of the simulation changed voluntarily, those files must be locally deleted so they can be regenerated by running the tests. Their modifications must be pushed to the repository.


## Non Regression Tests

For each line of the *regression-tests* file, the class ```RegressionSceneList``` store all the parameters, as well as the scene path and its reference path, inside the a structure ```RegressionSceneData``` .

The result of this process is thus a vector of ```RegressionSceneData``` structures: ```std::vector<RegressionSceneData> m_scenes;```

Then, for each ```RegressionSceneData``` a gtest is created and the method ```runTest``` from the Regression_test class will be called to really perform the test (or create the reference).


For the moment non regression tests class are: 
- **StateRegression_test**: At each step, the state (position/velocity) of every independent dofs is compared to values in reference files.
- **TopologyRegression_test**: At each step, the number of topology element of every topology container is compared to values in reference files.

# How to run the regression tests

The program **Regression_test** can't take arguments but will use several Environment variables to run correctly:
- REGRESSION_SCENES_DIR : path to the root folder containing the scenes: SOFA_DIR
- REGRESSION_REFERENCES_DIR : path to the root folder containing the references
- SOFA_ROOT : path to sofa build directory.

The script **regression_test.py** will execute the program and add the arguments as Env variables. See example of use inside the script.


# How to add new tests

## Add a scene to be tested

If the scene is already in Sofa repository: 
1. Just add its path inside the corresponding file: *Examples/RegressionStateScenes.regression-tests* for state test or *Examples/RegressionTopologyScenes.regression-tests* for topology test.
2. Create the reference file by runing the **Regression_test** program.
3. Push the list file into sofa/sofa-framework repository and the references into the sofa/regression repository.

If the scene is inside a plugin:
Create first a new *.regression-tests* file inside your plugin and do the 3 steps above.

## Add a new non-regression test

To add a new type of test you will need to add:

- Inside the **RegressionSceneList** file:
  - Update the ```RegressionSceneData``` structure to store, per scene, the data needed for the test.

- Inside the **Regression_test** file:
  - Add a new **xxRegressionSceneList** to specify the targeted name file. For example ```static struct StateRegressionSceneList : public RegressionSceneList``` is looking for "RegressionStateScenes.regression-tests" files.
  - Add a new class **xxRegression_test** inheriting from **BaseRegression_test**. And implement the method ```void runTestImpl(RegressionSceneData data, sofa::simulation::Node::SPtr root, bool createReference = false);``` with the wanted test. 
  This method is called by ```BaseRegression_test::runTest``` which will check for the scene.
  
  See for example ```class StateRegression_test : public BaseRegression_test``` where runTestImpl check At each step, the state (position/velocity) of every independent dofs is compared to values in reference files and if the mean difference per node exceed threshold this will be reported as an error.

- Finally in Regression_test.cpp you need to add the code to create a gtest for each RegressionSceneData of your list with your xxRegression_test::runTest method.

See for example the code of StateRegression_test:
```
/// Create one instance of StateRegression_test per scene in stateRegressionSceneList.m_scenes list
/// Note: if N differents TEST_P(StateRegression_test, test_N) are created this will create M x N gtest. M being the number of values in the list.
INSTANTIATE_TEST_CASE_P(Regression_test,
    StateRegression_test,
    ::testing::ValuesIn( stateRegressionSceneList.m_scenes ),
    StateRegression_test::getTestName);

// Run state regression test on the listed scenes
TEST_P(StateRegression_test, sceneTest)
{
    runTest(GetParam());
}
```
